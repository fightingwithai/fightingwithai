---
/**
 * Text-to-Speech component using the Web Speech API.
 * Provides play/pause, stop, and speed controls.
 */
---

<div class="tts-player" id="tts-player">
  <button class="tts-btn tts-play" id="tts-play" aria-label="Read article aloud">
    <span class="tts-icon play-icon">▶</span>
    <span class="tts-icon pause-icon hidden">⏸</span>
    <span class="tts-label">Listen</span>
  </button>

  <button class="tts-btn tts-stop hidden" id="tts-stop" aria-label="Stop reading">
    <span class="tts-icon">⏹</span>
  </button>

  <div class="tts-speed hidden" id="tts-speed-control">
    <label for="tts-speed" class="sr-only">Speed</label>
    <select id="tts-speed" aria-label="Reading speed">
      <option value="0.75">0.75×</option>
      <option value="1" selected>1×</option>
      <option value="1.25">1.25×</option>
      <option value="1.5">1.5×</option>
      <option value="2">2×</option>
    </select>
  </div>
</div>

<style>
  .tts-player {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
  }

  .tts-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    background-color: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .tts-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .tts-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .tts-play.playing {
    background-color: var(--color-accent-dim);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .tts-icon {
    font-size: var(--text-sm);
    line-height: 1;
  }

  .tts-label {
    font-size: var(--text-sm);
  }

  .tts-stop {
    padding: var(--space-2);
  }

  .tts-speed select {
    padding: var(--space-1) var(--space-2);
    font-family: inherit;
    font-size: var(--text-sm);
    background-color: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: border-color var(--transition-base);
  }

  .tts-speed select:hover {
    border-color: var(--color-accent);
  }

  .tts-speed select:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .hidden {
    display: none !important;
  }

  /* Hide entire component if speech synthesis not supported */
  .tts-unsupported {
    display: none;
  }
</style>

<script is:inline>
(function() {
  if (!('speechSynthesis' in window)) {
    document.getElementById('tts-player')?.classList.add('tts-unsupported');
    return;
  }

  const synth = window.speechSynthesis;
  const player = document.getElementById('tts-player');
  const playBtn = document.getElementById('tts-play');
  const stopBtn = document.getElementById('tts-stop');
  const speedControl = document.getElementById('tts-speed-control');
  const speedSelect = document.getElementById('tts-speed');

  const ui = {
    playIcon: playBtn?.querySelector('.play-icon'),
    pauseIcon: playBtn?.querySelector('.pause-icon'),
    label: playBtn?.querySelector('.tts-label')
  };

  const state = { utterance: null, playing: false, paused: false };

  const EXCLUDE_SELECTORS = [
    '.tts-player', '.breadcrumbs', 'nav', 'script',
    'style', '.related-content', '.content-nav'
  ];

  function getArticleText() {
    const article = document.querySelector('article');
    if (!article) return '';

    const clone = article.cloneNode(true);
    EXCLUDE_SELECTORS.forEach(sel =>
      clone.querySelectorAll(sel).forEach(el => el.remove())
    );
    return clone.textContent?.trim() || '';
  }

  function setUIState(mode) {
    const isActive = mode === 'playing' || mode === 'paused';
    const showPlay = mode !== 'playing';

    ui.playIcon?.classList.toggle('hidden', !showPlay);
    ui.pauseIcon?.classList.toggle('hidden', showPlay);
    ui.label.textContent = mode === 'playing' ? 'Pause' : mode === 'paused' ? 'Resume' : 'Listen';
    playBtn?.classList.toggle('playing', isActive);
    stopBtn?.classList.toggle('hidden', !isActive);
    speedControl?.classList.toggle('hidden', !isActive);
  }

  function stop() {
    synth.cancel();
    Object.assign(state, { utterance: null, playing: false, paused: false });
    setUIState('stopped');
  }

  function speak(updateUI = true) {
    const text = getArticleText();
    if (!text) return;

    synth.cancel();
    state.utterance = new SpeechSynthesisUtterance(text);
    state.utterance.rate = parseFloat(speedSelect?.value || '1');
    state.utterance.onend = stop;
    state.utterance.onerror = (e) => e.error !== 'interrupted' && stop();

    synth.speak(state.utterance);
    Object.assign(state, { playing: true, paused: false });
    if (updateUI) setUIState('playing');
  }

  playBtn?.addEventListener('click', () => {
    if (!state.playing) {
      speak();
    } else if (state.paused) {
      synth.resume();
      state.paused = false;
      setUIState('playing');
    } else {
      synth.pause();
      state.paused = true;
      setUIState('paused');
    }
  });

  stopBtn?.addEventListener('click', stop);

  speedSelect?.addEventListener('change', () => {
    if (state.playing && !state.paused) speak(false);
  });

  window.addEventListener('beforeunload', stop);
})();
</script>
