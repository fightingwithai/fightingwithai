---
/**
 * Dynamic content page for all collections.
 * Handles concepts, failure-modes, and patterns.
 */
import Layout from "../../layouts/Layout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import ContentNav from "../../components/ContentNav.astro";
import RelatedContent from "../../components/RelatedContent.astro";
import TextToSpeech from "../../components/TextToSpeech.astro";
import { getCollection } from "astro:content";
import {
  COLLECTION_NAMES,
  COLLECTION_CONFIG,
  getNavNeighbors,
  resolveRelatedContent,
  type CollectionName,
} from "../../utils/collections";

export async function getStaticPaths() {
  const paths = [];

  for (const collectionName of COLLECTION_NAMES) {
    const entries = await getCollection(collectionName);
    for (const entry of entries) {
      paths.push({
        params: { collection: collectionName, slug: entry.slug },
        props: { entry, collectionName },
      });
    }
  }

  return paths;
}

const { entry, collectionName } = Astro.props as {
  entry: Awaited<ReturnType<typeof getCollection>>[number];
  collectionName: CollectionName;
};

const { Content } = await entry.render();
const isPlaceholder = entry.body.trim().toLowerCase() === "todo";

// Get prev/next navigation using compass
const { prev, next } = await getNavNeighbors(collectionName, entry.slug);

const relatedItems = await resolveRelatedContent(entry.data.relatesTo || []);

const config = COLLECTION_CONFIG[collectionName];
---

<Layout
  title={entry.data.title}
  currentSection={config.displayName}
  currentSectionSlug={collectionName}
  pageTitle={entry.data.title}
>
  <article>
    <Breadcrumbs collection={collectionName} title={entry.data.title} />

    <h1>{entry.data.title}</h1>

    {!isPlaceholder && <TextToSpeech />}

    {isPlaceholder ? (
      <div class="placeholder-notice">
        <p>This content is coming soon.</p>
      </div>
    ) : (
      <Content />
    )}

    <RelatedContent items={relatedItems} />
    <ContentNav prev={prev} next={next} currentCollection={collectionName} />
  </article>
</Layout>
